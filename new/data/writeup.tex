\documentclass[pdftex,11pt,letter]{article}
\input{include.tex}
\usepackage{cancel}
\usepackage[margin=0.75in]{geometry}
\title{\textbf{Implicit Runge Kutta Method}}
\author{Komahan Boopathy~~\url{komahan@gatech.edu}} \date{\today}

\begin{document}
\maketitle
\vspace{-0.25in}
\rule{\linewidth}{2pt}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%  NOMENCLATURE %%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section*{Nomenclature}
\begin{minipage}[b]{0.5\linewidth}\centering
\begin{tabular}{@{}lcl@{}}
$s$   && number of stages\\
$h$   && time step size \\
$i,j$ && stage indices \\
$k$   && time index \\
$c_j,b_j,a_{ij}$ && Butcher tableau entries \\
$q_k$ && state variable value at previous/initial time \\
$q_{k,i}$ && stage state variable values relative to previous/initial time \\
$R_i$  && $i-$th stage residual equation \\
$J_{ij}$  && $i,j-$th stage jacobian entry \\
\end{tabular}
\end{minipage}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%  EXPLICIT RUNGE KUTTA %%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Governing Equations in Explicit Form}

Consider a first order differential equation  of the form
\begin{equation}
  \pf{q}{t} = f(t, q)
\end{equation}
In IRK, one needs to solve a system of nonlinear stage equations at
each time step. 
\paragraph{Stage Equations:}
The stage equations to be solved are as follows:
\begin{equation}\label{stage_explicit}
  q_{k,i} = q_{k} + h \sum_{j=1}^s a_{ij} f(t_{k,j}, q_{k,j}) \quad i = 1,\ldots,s 
\end{equation}
Here, $t_{k,i}$ is provided by the formula:
\begin{equation}
  t_{k,j} = t_k + c_j h
\end{equation}
\paragraph{Residual of Stage Equations:}
 The residual of the stage equations:
\begin{equation}
  F_i = q_{k,i} - q_{k} - h \sum_{j=1}^s a_{ij} f(t_{k,j}, q_{k,j}) \quad i = 1,\ldots,s 
\end{equation}
\paragraph{Jacobian of Stage Equations:}
The jacobian of the stage equations:
\begin{equation}
  \begin{split}
    J_{ii} = 1 - h a_{ii} \pd{f(t_{k,i}, q_{k,i})}{q} \quad \forall i = j \\
    J_{ij} = - h a_{ij} \pd{f(t_{k,j}, q_{k,j})}{q} \quad \forall i \ne j
  \end{split}
\end{equation}
Note that we may save a few function and derivative evaluations when
the corresponding Butcher tableau entries $a_{ij}$ are zero. Along the
same line of discussion, DIRK offers greater computational savings.

\paragraph{Time Marching:}
Once the stage states $q_{k,i}$ are found, they can be used to find the next
value of the state as follows:
\begin{equation}
  q_{k+1} = q_{k} + \sum_{j=1}^s b_j f(k,j,qk,j)
\end{equation}

\subsection{Two-Stage IRK Example}

Consider an example of two-stage IRK. The stage residual is:
\begin{equation}\label{eq:sr2}
  \begin{split}
    \mathbf{F} & = \left\{
    \begin{array}{rr} q_{k,1} - q_{k} - h \sum_{j=1}^s a_{1j} f(t_{k,j}, q_{k,j}) \\
      q_{k,2} - q_{k} - h \sum_{j=1}^s a_{2j} f(t_{k,j}, q_{k,j})
    \end{array} \right\}\\
    & = \left\{
    \begin{array}{rr} q_{k,1} - q_{k} -  a_{11} h f(t_{k,1}, q_{k,1}) + a_{12} h f(t_{k,2}, q_{k,2})\\
      q_{k,2} - q_{k} - a_{21} h f(t_{k,1}, q_{k,1}) + a_{22} h f(t_{k,2}, q_{k,2})
    \end{array} \right\}
  \end{split}
\end{equation}
We need to solve for $q_{k,1}$ and $q_{k,2}$, differentiating $\mathbf{F}$ we get
the stage jacobian matrix:
\begin{equation}\label{eq:sj2}
  \mathbf{J} =  \begin{bmatrix}
    1 - h a_{11} \pd{f(t_{k,1}, q_{k,1})}{q} & - h a_{12} \pd{f(t_{k,2}, q_{k,2})}{q}\\
    - h a_{21} \pd{f(t_{k,1}, q_{k,1})}{q}   & 1 - h a_{22} \pd{f(t_{k,2}, q_{k,2})}{q}
  \end{bmatrix}
\end{equation}
Eqs.~\eqref{eq:sr2} and ~\eqref{eq:sj2} are to be solved for the state
variable values $q_{k,1}$ and $q_{k,2}$, using iterative methods such as the
Newton's method.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%  IMPLICIT RUNGE KUTTA %%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Governing Equations in Implicit Form}

Consider first order differential equation in descriptor form
\begin{equation}
  R(t, q, \pf{q}{t}) = 0
\end{equation}

\paragraph{Stage Equations:}
The key is to write Eq.~\ref{stage_explicit} in the following form
\begin{equation}\label{stage_implicit}
  q_{k,i} = q_{k} + h \sum_{j=1}^s a_{ij} \dot{q}_{k,j} \quad i = 1,\ldots,s 
\end{equation}

\paragraph{Residual of Stage Equations:}

The residual of the stage equations:
\begin{equation}
  F_i = q_{k,i} - q_{k} - h \sum_{j=1}^s a_{ij} \dot{q}_{k,i} \quad i = 1,\ldots,s 
\end{equation}

\paragraph{Jacobian of Stage Equations:}

The jacobian of the stage equations:
\begin{equation}
  \begin{split}
    J_{ii} = 1 - h a_{ii} \pd{\dot{q}(t_{k,i}, q_{k,i})}{q} \quad \forall i = j \\
    J_{ij} = - h a_{ij} \pd{\dot{q}(t_{k,j}, q_{k,j})}{q} \quad \forall i \ne j
  \end{split}
\end{equation}

\paragraph{Time Marching:}

Once the stage derivatives $\dot{q}_{j}$ are found, they can be used to find the next
value of the state as follows:
\begin{equation}
  q_{k+1} = q_{k} + \sum_{j=1}^s b_j \dot{q}_j
\end{equation}

\clearpage

\appendix
\section{Compute Code}

\subsection{Time Marching}

\begin{verbatim}
    march: do k = 2, N + 1

       ! find the stage derivatives solving the nonlinear system
       call this % compute_stage_values(k, q)
        
       ! advance in time
       call this % update_states(k, q, qdot)

    end do march
\end{verbatim}


\subsection{Solve the Non-linear System}

\begin{verbatim}
    newton: do n = 1, this % max_newton
       
       ! Get the stage residual
       call this % compute_stage_residual(qk)
       
       ! Get the stage jacobian matrix
       call this % compute_stage_jacobian()

       ! Call lapack to solve the stage values system
       dq = this % R
       call DGESV(this % num_stages, 1, this % J, this % num_stages, &
            & IPIV, dq, this % num_stages, INFO)

       ! Check stop
       if (norm2(this % R) .le. this % tol .or. &
            & norm2(dq) .le. this % tol) then
          conv = .true.
          exit newton
       end if
       
       ! update q(k,i)
       this % Y = this % Y - dQ
       
    end do newton
\end{verbatim}

%\subsection{Runge-Kutta for Descriptor Systems}
\end{document}
